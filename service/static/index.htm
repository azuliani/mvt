<!DOCTYPE html>
<html>
<head>
<script src="./jquery.min.js"></script>
 
<title>WebSockets Client</title>
 
<script>

document.addEventListener("DOMContentLoaded", function() {
  
  var ws = null;
  var lastPing = new Date();

  function start(){
    console.log("Connecting now!")   
    if (ws) {
        ws.onmessage = function(){};
        ws.onclose = function(){};
        ws.onopen = function(){};
        ws.close()
    }
    var loc = window.location
    ws = new WebSocket("ws://" + loc.hostname + ":" + loc.port + "/pushupdates");
    ws.onopen = function(){
      console.log('connected!');
      ws.send("gimmenumber!")
    };
    ws.onmessage = function(msg){
      var obj = JSON.parse(msg.data);
      console.log(obj)
      if (obj.totalpushes || obj.totalpushes === 0){
          $('#pushes').text(obj.totalpushes);
      }
      if (obj.ping) {
        lastPing = new Date();
      }
    }

    ws.onclose = function(){
      console.log('closed!');
      //reconnect now
      check();
    };

  }

  function check(){
    if (!ws || ws.readyState == 3) {
        return start();
    }
    if (new Date() - lastPing > 5000) {
        return start();
    } 
  }

  start();

  setInterval(check, 5000);

});



</script>

</head>
<body>
<div id="wrapper">
 
    <div id="container">
 
        <h1>Totaal # drukken op de knop:</h1>
    
        <span id="pushes" style="font-size: 230pt">?</span>
        
 
    </div><!-- #container -->
 
</div>
</body>
</html>
